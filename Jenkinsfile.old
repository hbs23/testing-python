pipeline {
    agent any

    environment {
        // contoh: beda ENV untuk app
        APP_ENV = "${env.BRANCH_NAME == 'main' ? 'production' : 'staging'}"
        PATH = "/var/jenkins_home/.local/bin:${env.PATH}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build & Test') {
            steps {
                sh 'echo "Build & test untuk ${APP_ENV}"'
                // mvn test / go test / npm test dll
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('SonarCube_Testing') {
                    script {
                        def scannerHome = tool 'SonarCube_Scanner_Testing'
                        sh """
                        "${scannerHome}/bin/sonar-scanner" \
                            -Dsonar.projectKey=testing-python \
                            -Dsonar.sources=. \
                            -Dsonar.python.version=3
                        """
                    }
                }
            }
        }

        stage('SonarQube Quality Gate') {
            steps {
                timeout(time: 2, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: false
                }
            }
        }

        stage('Semgrep - Generate Report SARIF (All Severity)') {
            steps {
                sh '''
                  mkdir -p reports

                  semgrep scan \
                    --config p/security-audit \
                    --config p/owasp-top-ten \
                    --config p/secrets \
                    --metrics=off \
                    --sarif --output reports/semgrep.sarif \
                    . || true
                '''
            }
        }

        stage('Semgrep - Enforce Medium/High Only') {
            steps {
                sh '''
                  semgrep scan \
                    --config p/security-audit \
                    --config p/owasp-top-ten \
                    --config p/secrets \
                    --metrics=off \
                    --severity WARNING \
                    --severity ERROR \
                    --error \
                    .
                '''
            }
        }

        stage('Deploy to STAGING') {
            when {
                branch 'staging'
            }
            steps {
                sh '''
                  echo "Deploy ke STAGING"
                  # contoh:
                  # kubectl --context=staging apply -f k8s/
                '''
            }
        }

        stage('Deploy to PRODUCTION') {
            when {
                branch 'main'
            }
            steps {
                sh '''
                  echo "Deploy ke PRODUCTION"
                  # kubectl --context=production apply -f k8s/
                '''
                sshagent(['Server_Jenkins_Demo']) {
                    sh '''
                      ssh -o StrictHostKeyChecking=no ubuntu@13.212.183.71 " ls -lah && 
                      docker ps
                      "
                    '''
                }
            }
        }
    }
    post {
        always {
            archiveArtifacts artifacts: 'reports/semgrep.sarif', fingerprint: true
        }
    }
}
