openapi: 3.0.3
info:
  title: Clean Flask Demo API
  version: 1.0.0
  description: >
    Clean version of Flask demo API (no intentional vulnerabilities).
    Digunakan untuk testing pipeline DevSecOps (SonarQube, Semgrep, Trivy, ZAP API Scan).

servers:
  - url: http://localhost:9500
    description: Local development
  - url: http://13.212.114.218:9500
    description: Remote / lab environment

paths:
  /health:
    get:
      summary: Health check
      operationId: healthCheck
      responses:
        "200":
          description: Service and DB are healthy
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthResponse"
        "500":
          description: DB or app error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HealthErrorResponse"

  /login:
    post:
      summary: User login
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
          application/x-www-form-urlencoded:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Login success
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "400":
          description: Missing username or password
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /users/{user_id}:
    get:
      summary: Get user detail
      operationId: getUserById
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: User found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /search:
    get:
      summary: Search users by username
      operationId: searchUsers
      parameters:
        - name: q
          in: query
          required: false
          schema:
            type: string
          description: Search keyword for username
      responses:
        "200":
          description: List of users matching search keyword
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SearchResponse"

  /change_password:
    post:
      summary: Change user password
      operationId: changePassword
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChangePasswordRequest"
          application/x-www-form-urlencoded:
            schema:
              $ref: "#/components/schemas/ChangePasswordRequest"
      responses:
        "200":
          description: Password changed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
        "400":
          description: user_id or new_password missing
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /upload:
    post:
      summary: Upload file
      operationId: uploadFile
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
              required:
                - file
      responses:
        "200":
          description: File uploaded successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadResponse"
        "400":
          description: No file or invalid file type
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /config:
    get:
      summary: Get app config info (non-sensitive)
      operationId: getConfig
      responses:
        "200":
          description: App configuration (no secrets)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConfigResponse"

components:
  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
        db:
          type: string
          example: connected

    HealthErrorResponse:
      type: object
      properties:
        status:
          type: string
          example: error
        db_error:
          type: string
          example: "Access denied for user 'root'@'localhost' (using password: YES)"

    LoginRequest:
      type: object
      properties:
        username:
          type: string
          example: admin
        password:
          type: string
          format: password
          example: admin123
      required:
        - username
        - password

    LoginResponse:
      type: object
      properties:
        message:
          type: string
          example: Login success
        user:
          $ref: "#/components/schemas/User"

    User:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        username:
          type: string
          example: admin
        email:
          type: string
          format: email
          example: admin@example.com

    SearchResponse:
      type: object
      properties:
        results:
          type: array
          items:
            $ref: "#/components/schemas/User"

    ChangePasswordRequest:
      type: object
      properties:
        user_id:
          type: integer
          format: int64
          example: 1
        new_password:
          type: string
          format: password
          example: "Str0ngP@ss!"
      required:
        - user_id
        - new_password

    MessageResponse:
      type: object
      properties:
        message:
          type: string
          example: Password changed successfully

    UploadResponse:
      type: object
      properties:
        message:
          type: string
          example: File uploaded
        path:
          type: string
          example: uploads/log.txt

    ConfigResponse:
      type: object
      properties:
        db_host:
          type: string
          example: 172.17.0.1
        db_name:
          type: string
          example: hasan_testing_db
        app_env:
          type: string
          example: development

    ErrorResponse:
      type: object
      properties:
        message:
          type: string
          example: Error message